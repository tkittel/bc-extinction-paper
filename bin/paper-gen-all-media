#!/usr/bin/env python

import pathlib
import subprocess
import shlex
import sys
import multiprocessing
import tqdm
import random

cmds = """
plot xscanforpaper primary outfile=<DESTDIR>/yrefeval_primary.pdf
plot xscanbands outfile=<DESTDIR>/yrefeval_bands.pdf
printcode latex <DESTDIR>/recipe_TAGHERE.tex
plot table1 updated destdir=<DESTDIR>
plot table1 diff destdir=<DESTDIR>
plot table3 updated destdir=<DESTDIR>
plot table3 diff destdir=<DESTDIR>
plot table4 updated destdir=<DESTDIR>
plot table4 diff destdir=<DESTDIR>
plot tableF updated destdir=<DESTDIR>
# NOTE: Splitting th-point at 45 into 45+-epsilon for lorentz, to not miss the breakdown near 45deg!
plot cmprecipes primary outfile=<DESTDIR>/cmprecipes_primary.pdf
plot cmprecipes scndgauss outfile=<DESTDIR>/cmprecipes_scndgauss.pdf
plot cmprecipes scndlorentz outfile=<DESTDIR>/cmprecipes_scndlorentz.pdf split45
plot cmprecipes scndfresnel outfile=<DESTDIR>/cmprecipes_scndfresnel.pdf
## plot cmprecipes lux primary outfile=<DESTDIR>/cmprecipes_primary_lux.pdf
## plot cmprecipes lux scndgauss outfile=<DESTDIR>/cmprecipes_scndgauss_lux.pdf
## plot cmprecipes lux scndlorentz outfile=<DESTDIR>/cmprecipes_scndlorentz_lux.pdf split45
## plot cmprecipes lux scndfresnel outfile=<DESTDIR>/cmprecipes_scndfresnel_lux.pdf
HEAVY::plot breakdown primary outfile=<DESTDIR>/prec_classicrecipe_2d_primary.pdf
HEAVY::plot breakdown scndgauss outfile=<DESTDIR>/prec_classicrecipe_2d_scndgauss.pdf
HEAVY::plot breakdown scndlorentz outfile=<DESTDIR>/prec_classicrecipe_2d_scndlorentz.pdf
HEAVY::plot breakdown scndfresnel outfile=<DESTDIR>/prec_classicrecipe_2d_scndfresnel.pdf

plot highx outfile=<DESTDIR>/highx.pdf
plot feta outfile=<DESTDIR>/f_of_eta.pdf
plot phi outfile=<DESTDIR>/phi_of_s.pdf

plot integrand primary outfile=<DESTDIR>/integrand_gP_of_eta_g.pdf
plot integrand outfile=<DESTDIR>/integrand_gPgGgLgF_of_eta_g.pdf

plot fresnelrichardson
"""

def parse_cmds( skip_heavy ):
    bindir = pathlib.Path(__file__).parent.absolute()
    destdir = bindir.parent.joinpath('paper','generated').absolute()
    destdir.mkdir(parents=True,exist_ok=True)
    for c in cmds.splitlines():
        c = c.strip()
        if not c or c.startswith('#'):
            continue
        if c.startswith('HEAVY::'):
            c = c[len('HEAVY::'):]
            if skip_heavy:
                print("SKIPPING HEAVY COMMAND: %s"%c)
                continue
        c = shlex.split(c.strip())
        prog = bindir.joinpath(c[0])
        assert prog.is_file()
        c[0] = prog
        for i in range(1,len(c)):
            if '<DESTDIR>' in c[i]:
                c[i] = c[i].replace('<DESTDIR>',str(destdir))
        yield [str(e) for e in c]

def worker( cmd ):
    res = subprocess.run([sys.executable] + cmd,check=True, capture_output=True)
    assert res.returncode==0
    return 'success'

def main():
    do_mp = ( 'nomp' not in sys.argv[1:] )
    skip_heavy = ( 'quick' in sys.argv[1:] )
    cmdlist = list( parse_cmds(skip_heavy) )

    if do_mp:
        worklist = cmdlist[:]
        random.shuffle(worklist)#more reliable progress bar
        with multiprocessing.Pool() as pool:
            results = list(tqdm.tqdm( pool.imap_unordered(worker, worklist,chunksize=1),
                                      total=len(worklist) ))
    else:
        results = []
        for cmd in cmdlist:
            print()
            print("Launching: %s"%shlex.join(cmd))
            print()
            results.append( worker(cmd) )

    if len(results) != len(cmdlist) or set(results) != set(['success']):
        raise SystemExit('ERROR: Errors detected during some jobs.')

    print("All done")

if __name__ == '__main__':
    main()
