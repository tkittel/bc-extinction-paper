from .mpmath import mp, mpf

class F_of_Eta:

    # Evaluate f(eta) (given by fractional part of eq. 29, with
    # eta=pi*eps_1*beta).
    #
    # f=(eta^2-eta*sin(2*eta)+(sin(eta))^2)/eta^4
    #
    # For small arguments, the function is evaluated via a Taylor expansion
    # to ensure numerical precision and stability.

    def __init__( self ):
        # Taylor expansion to be used for eta<0.1. Code validated and
        # produced by the script bin/sagemath_taylor_f_of_eta:
        c0 = mpf("1")
        c2 = mpf("-2/9")
        c4 = mpf("1/45")
        c6 = mpf("-2/1575")
        c8 = mpf("2/42525")
        c10 = mpf("-4/3274425")
        c12 = mpf("1/42567525")
        c14 = mpf("-2/5746615875")
        c16 = mpf("2/488462349375")
        c18 = mpf("-4/102088631019375")
        c20 = mpf("2/6431583754220625")
        c22 = mpf("-4/1923043542511966875")
        c24 = mpf("4/336532619939594203125")
        c26 = mpf("-8/136295711075535652265625")
        c28 = mpf("1/3952575621190533915703125")
        c30 = mpf("-2/2083007352367411373575546875")
        c32 = mpf("2/618653183653121177951937421875")
        c34 = mpf("-4/411404367129325583338038385546875")
        c36 = mpf("2/76109807918925232917537101326171875")
        c38 = mpf("-4/62333932685599765759462885986134765625")
        c40 = mpf("4/28112603641205494357517761579746779296875")
        c42 = mpf("-8/27803365001152233919585066202369564724609375")
        c44 = mpf("2/3753454275155551579143983937319891237822265625")
        c46 = mpf("-4/4410308773307773105494181126350872204441162109375")
        c48 = mpf("4/2809366688597051468199793377485505594229020263671875")
        c50 = mpf("-8/3868497930198139871711115480797541203253360903076171875")
        def taylor( eta ):
            x = eta*eta
            return c0+x*(c2+x*(c4+x*(c6+x*(c8+x*(c10+x*(c12+x*(c14+x*(c16+x*(c18+x*(c20+x*(c22+x*(c24+x*(c26+x*(c28+x*(c30+x*(c32+x*(c34+x*(c36+x*(c38+x*(c40+x*(c42+x*(c44+x*(c46+x*(c48+x*c50))))))))))))))))))))))))
        self._eval_taylor = taylor

    def __call__( self, eta ):
        if eta < 0:
            eta = -eta
        if eta < 0.1:
            return self._eval_taylor(eta)
        s = mp.sin(eta)
        s2 = mp.sin(2*eta)
        etasq = eta**2
        return  ( etasq - eta*s2 + s**2 ) / (etasq**2)

def test_f_of_eta():
    #Reference values via sagemath
    f_of_eta_refvals = [

        ( mpf('0'), mpf('1') ),
        #two vals on each side of taylor cutoff:
        ( mpf('9999999999999999999999999999999999999999999999999/100000000000000000000000000000000000000000000000000'), mpf('0.997779998730628919604789140765862662171466426954626194418875055282558051163618631284412640682022778024817') ),
        ( mpf('10000000000000000000000000000000000000000000000001/100000000000000000000000000000000000000000000000000'), mpf('0.997779998730628919604789140765862662171466426954625307306240886901906359181079186058934493108196357662026') ),

        #First value below with swapped sign:
        ( mpf('-1/70000000000'), mpf('0.999999999999999999999954648526077097505668935165903095932250451200877725200073881320640749191762680538982') ),
        #A whole bunch of values:
        ( mpf('1/70000000000'), mpf('0.999999999999999999999954648526077097505668935165903095932250451200877725200073881320640749191762680538982') ),
        ( mpf('1/40000000000'), mpf('0.999999999999999999999861111111111111111111119791666666666666666666356646825396825396825404001782039976484') ),
        ( mpf('1/20000000000'), mpf('0.999999999999999999999444444444444444444444583333333333333333333313492063492063492063493900646678424456202') ),
        ( mpf('1/10000000000'), mpf('0.999999999999999999997777777777777777777779999999999999999999998730158730158730158730629041740152851263962') ),
        ( mpf('1/7000000000'), mpf('0.999999999999999999995464852607709750566902679439122587810634447071305863135797941881799956191615350554416') ),
        ( mpf('1/4000000000'), mpf('0.999999999999999999986111111111111111111197916666666666666666356646825396825396826114463918283362727806007') ),
        ( mpf('1/2000000000'), mpf('0.999999999999999999944444444444444444445833333333333333333313492063492063492063675778953556731334507919329') ),
        ( mpf('1/1000000000'), mpf('0.999999999999999999777777777777777777799999999999999999998730158730158730158777189888300999412109301633111') ),
        ( mpf('1/700000000'), mpf('0.999999999999999999546485260770975056781896432042204636946030073043477322307537454792513746172486831111504') ),
        ( mpf('1/400000000'), mpf('0.999999999999999998611111111111111111979166666666666666356646825396825396897160677542621987054781534878261') ),
        ( mpf('1/200000000'), mpf('0.999999999999999994444444444444444458333333333333333313492063492063492081863609641387419153267367553081839') ),
        ( mpf('1/100000000'), mpf('0.999999999999999977777777777777777999999999999999998730158730158730163433274544385655484550722645960741222') ),
        ( mpf('1/70000000'), mpf('0.999999999999999954648526077097506594474524503679011835987245892982529912601065293258591531298906500781953') ),
        ( mpf('1/40000000'), mpf('0.999999999999999861111111111111119791666666666666356646825396825404001782039976484304429105396367302529443') ),
        ( mpf('1/20000000'), mpf('0.999999999999999444444444444444583333333333333313492063492063493900646678424456082938225795368658246882453') ),
        ( mpf('1/10000000'), mpf('0.999999999999997777777777777779999999999999998730158730158730629041740152851141803522755903731776747649764') ),
        ( mpf('1/7000000'), mpf('0.999999999999995464852607709759822296265444942698128020570208432566753541074455319026379280003740829785898') ),
        ( mpf('1/4000000'), mpf('0.999999999999986111111111111197916666666666356646825396826114463918283361562809572482192930048077152490539') ),
        ( mpf('1/2000000'), mpf('0.999999999999944444444444445833333333333313492063492063675778953556730141551570123004429800064720678399213') ),
        ( mpf('1/1000000'), mpf('0.999999999999777777777777799999999999998730158730158777189888300998190522000045833061706077578745421191041') ),
        ( mpf('1/700000'), mpf('0.999999999999546485260771067610717756479557769836481053591776253471220492662332007347668370710081454954818') ),
        ( mpf('1/400000'), mpf('0.999999999998611111111111979166666666356646825396897160677542610337090433818024530314491742379934226536757') ),
        ( mpf('1/200000'), mpf('0.999999999994444444444458333333333313492063492081863609641375489589775309796391145595370591696283091185960') ),
        ( mpf('1/100000'), mpf('0.999999999977777777777999999999998730158730163433274544373439611534873122174709441493686055749340322428778') ),
        ( mpf('1/70000'), mpf('0.999999999954648526078023045953064314121356761737775949475204280662275729239876721655176074244450141351208') ),
        ( mpf('1/40000'), mpf('0.999999999861111111119791666666356646825404001782039859984660953323094184471348290533045164700275719014780') ),
        ( mpf('1/20000'), mpf('0.999999999444444444583333333313492063493900646678305160448023326247532384317731178770154545500462893059378') ),
        ( mpf('1/10000'), mpf('0.999999997777777779999999998730158730629041740030692411668284684154219721533476072328611215274632051480556') ),
        ( mpf('1/7000'), mpf('0.999999995464852616965153397508623655550689300194401589450090581539709062668898117038593981407716653158189') ),
        ( mpf('1/4000'), mpf('0.999999986111111197916666356646826114463917118365129437984583792483569045675940137005781359370500549274319') ),
        ( mpf('1/2000'), mpf('0.999999944444445833333313492063675778952363773798080593694272229020184915356540810433067682837666151352412') ),
        ( mpf('1/1000'), mpf('0.999999777777799999998730158777189887079410912426785094627544342244998156249493704682941072846575689168592') ),
        ( mpf('1/700'), mpf('0.999999546485353324992677304180010147103823010278379970483739803552683619509140834873111929790926824222383') ),
        ( mpf('1/400'), mpf('0.999998611111979166356646897160665892647389609549919626299416571095985473449828924773292000905147778728912') ),
        ( mpf('1/200'), mpf('0.999994444458333313492081863597711817732896957893908352182996651620212695364172023896618409883094330300734') ),
        ( mpf('1/100'), mpf('0.999977777999998730163433262328523915790700076206832335979382704637536610395294961889176472528304292245913') ),
        ( mpf('1/70'), mpf('0.999954649451606588255417697767153715883407084728345889412877720813805109735592328405070216529538812616316') ),
        ( mpf('1/40'), mpf('0.999861119791356654001665541616732013068404135990106752492003514746957908078897212966139923535741232636559') ),
        ( mpf('1/20'), mpf('0.999444583313493900527388405400196994578862649419043309645532685513228274423256749610967306461476999445104') ),
        ( mpf('1/10'), mpf('0.997779998730628919604789140765862662171466426954625750862557971092232205172348908671673566895109567865511') ),
        ( mpf('1/7'), mpf('0.995474097225232466594543619503483836814290326498131778080719387518849996160251919675078501961593726263943') ),
        ( mpf('1/4'), mpf('0.986197607363300319625529572913235707833999221754318004234345615524062282480465470641942857362381708986311') ),
        ( mpf('1/2'), mpf('0.945813674591710207572488567413795173161012148669653653257208277015913606674308532267267202958113718416634') ),
        ( mpf('1'), mpf('0.798775991447889498102764248838636252180745414089882176998601975360015166521256039917139200005125189873715') ),
        ( mpf('10/7'), mpf('0.629020050923275473588071325505169257999406363679894808784534989602772114173252641035442205927537530140857') ),
        ( mpf('5/2'), mpf('0.230540277604511565823988900598610080747876929632906149705318441018743825070917316007664675782135292924721') ),
        ( mpf('5'), mpf('0.0458234261103761204690450724530702701210850882354363259700622350857730917466169640203773523613682034404083') ),
        ( mpf('10'), mpf('0.00911665064618170274632078662310793545084710244077599740255710791529591819905684582072466274555937973982120') ),
        ( mpf('100/7'), mpf('0.00502389506431573998620664613127924919450273643436079334254855795663065071352828579396315487378094709253180') ),
        ( mpf('25'), mpf('0.00161683683412058153730771292836701454118708848764567534642061939279886443777057576958684883217893680160024') ),
        ( mpf('50'), mpf('0.000404061939619095055634524305802562216053679455049642417721204726819739445620311739442065645707648676954853') ),
        ( mpf('100'), mpf('0.000100875861358838959552181244681644136948446248458129371650343752888415495907684023358210208698985009754820') ),
        ( mpf('1000/7'), mpf('0.0000489441357259194897057545436868067302083933837978178984786853130652319341067399880060600015298366750327186') ),
        ( mpf('250'), mpf('0.0000160301785282476377012636821828819176808773059924743869012887804059353428548264321975617021917545513094660') ),
        ( mpf('500'), mpf('3.99338846464313365389402427457331341170254815376264378785739339119195729108164292103151402600726827354396e-6') ),
        ( mpf('1000'), mpf('9.99070644225358413407744085735741553702159965037074100337897862197519030786363074437599538700381093172179e-7') ),
        ( mpf('10000/7'), mpf('4.90339984840085449856732741393067035585473182105204395504463526014503961121506484289242477649645894918553e-7') ),
        ( mpf('2500'), mpf('1.60063240672325474604660693739113109975808388610539320928381148932617005565962593131484966007744009147652e-7') ),
        ( mpf('5000'), mpf('4.00024464768354006243427682725912685864386558460069952855136781624229489942469042452608104794909078828296e-8') ),
        ( mpf('10000'), mpf('9.99941802457802117456596319793516083038007648526363028424643314160434551429319088048301682064776515604617e-9') ),
        ( mpf('100000/7'), mpf('4.89966485200469451992914329943942022091338535287625010260894517124867263028804582556960363913420924270047e-9') ),
        ( mpf('25000'), mpf('1.60006399107498463417170953584250262659169879661990737083744923042171612413785350829849242138190747530831e-9') ),
        ( mpf('50000'), mpf('3.99999714169565088462982464387285266660952103893290302125603361181391282173227352243017315152660194281497e-10') ),
        ( mpf('100000'), mpf('1.00000071451907992285465599135255849326040636898365301646086979039433605894973831378419100758162350220169e-10') ),
        ( mpf('1000000/7'), mpf('4.90002885804450079887469684149994358976512476731809470440288999498655326888887101772054599720018155911800e-11') ),
        ( mpf('250000'), mpf('1.59999886190570626402137978500987379999119944949178477261569820471944558139497721644757994441023613777176e-11') ),
        ( mpf('500000'), mpf('4.00000279994852335332335178292438598589115314104717784729649192943467253040087668023338771747912507962505e-12') ),
        ( mpf('1000000'), mpf('1.00000065571443805892156688945424127504278299894561270037651075126680471096453411551382254365701084075530e-12') ),
        ( mpf('10000000/7'), mpf('4.89999814094858722960082367465104426989877856859841173610312007259884143711004353830602696125713229638268e-13') ),
        ( mpf('2500000'), mpf('1.60000062498733550211859032795672807987534909827651604395270928192097789936974582515387670680065778141714e-13') ),
        ( mpf('5000000'), mpf('3.99999966356191802900490150035962114426359760031438450366165897233514284726613519533164221225912756768538e-14') ),
        ( mpf('10000000'), mpf('1.00000007631011351582037835726305446531452874053350621528108728279081978670364951746932103982068664229925e-14') ),
        ( mpf('100000000/7'), mpf('4.89999981924219731319373125255330461707296536968503919548680688909899860408200191812952671944352261686374e-15') ),
        ( mpf('25000000'), mpf('1.59999994715860898834738994372944275565342995961377503279828170709001090271211984187600126620113870474316e-15') ),
        ( mpf('50000000'), mpf('3.99999992546887892192999084235111080893684439984794165720441395481331547812515851257105499862735566890235e-16') ),
        ( mpf('100000000'), mpf('1.00000000677087470906545567848514344861531712298454403337159612655992246500939979436909505756566618627977e-16') ),
        ( mpf('1000000000/7'), mpf('4.90000002294071415662525259313280113751230059197994310176183304447049072671610395147377183578408989617668e-17') ),
        ( mpf('250000000'), mpf('1.60000000182210609379055959467337179120092942129229781973818358732149395741120923633606140374959777165753e-17') ),
        ( mpf('500000000'), mpf('3.99999999563325240570730603513368315770167861962723770942024675392116558028949502271663156700170444120566e-18') ),
        ( mpf('1000000000'), mpf('9.99999999085289541648903896373240412694849575619976327401717717368398560651155394687117180776642840537053e-19') ),
    ]
    f = F_of_Eta()
    maxerr = mpf('1e-102')
    for eta, ref in f_of_eta_refvals:
        v = f(eta)
        #print(type(v))
        d = abs(v-ref)/ref
        #print( eta, ref, v, d )
        print(eta, d)
        assert 0.0 <= d < maxerr
