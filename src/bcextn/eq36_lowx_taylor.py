from .mpmath import mp, mpf

def taylor_lowx_eq36( theta_degree, x, eps ):
    #Returns None if x is not low enough!
    sinth = mp.sin(mpf(theta_degree) * mp.pi/mpf(180) )
    x = mpf(x)
    eps = mpf(eps)*0.1 #safety
    taylor_fct = _taylor_lowx_eq36_create_fct( sinth )
    if x > mpf(1):
        #x is clearly too large
        return None
    if mpf(x)==0:
        return mpf(1), mpf(0)
    _, max_err = taylor_fct( x, only_error = True )
    if max_err > eps:
        #x is too large
        return None
    return taylor_fct( x )

def _taylor_lowx_eq36_create_fct( sinth ):
    #found by taylor expanding integrand, then integrating.
    sinth = mpf(sinth)
    def s( power ):
        return sinth**mpf(power)
    m = mpf
    c0 = m('2/3')
    c1 = m('-22/35')
    c2 = m('4738/17325')*(s('5/2') + m(2))
    c3 = m('-108240952/273648375')*(m(2)*s(3) + m(1))
    c4 = m('350769113251/2887355220750')*(m(13)*s('7/2') + m(2))
    c5 = m('-276478446363113/4269160933537500')*(m(43)*s(4) + m(2))
    c6 = m('19564394058822418571/1283790057226395468750')*(m(311)*s('9/2') + m(4))
    c7 = m('-36703165412564741196614548/1429514849663909766179296875')*(m(314)*s(5) + m(1))
    c8 = m('36928840127061822463096205687/7547838406225443565426687500000')*(m(2833)*s('11/2') + m(2))
    c9 = m('-33748450139852875393232090287374607/19822052940875302766351098083187500000')*(m(14173)*s(6) + m(2))
    c10 = m('19603807095172946325281028797499429174403/71931091630720835149483462686690932812500000')*(m(155921)*s('13/2') + m(4))
    c11 = m('-4404234687448218327421971987673239988236198193/27258363254423962203857012446476293758552734375000')*(m(467773)*s(7) + m(2))
    c12 = m('271729330015704263744140826096102038543392468179939/12187759378318041980588547405068480465324098593750000000')*(m(6081071)*s('15/2') + m(4))
    c13 = m('-1905969038362018082597633645314669909788695669993864257013/331136140946503929461065911291835084567987451682796875000000000')*(m(42567521)*s(8) + m(4))
    c14 = m('5903507038519501143784298379985297238620823232177510866209599031/8458592330951096425880657546389540873931381509862333763621093750000000')*(m('638512867')*s('17/2') + m(8))
    c15 = m('-86204560112829310767154769236518867366235607759705804898584404601/67524407134503654639728921504399745124869018714237960860804443359375000')*(m('638512874')*s(9) + m(1))
    c16 = m('107725131117286353966210744394213813735305091374757266317751547055561765579/780286680810597625462526165143453528771265344415719867227838046691750000000000000')*(m('10854718873')*s('19/2') + m(2))
    c17 = m('-192093005779411254048810194953839432177316626944299322096503088051203039754862607/6781064316086202228435193119109777788134142587932894136953163381366167781250000000000000')*(m('97692469873')*s(10) + m(2))
    c18 = m('670908254986834689460447914327944885431110936072775648170485974671797992908741805619503811/242692684251902441619302255459530234086751841320264246970676199247886507506710760156250000000000000')*(m('1856156927621')*s('21/2') + m(4))
    c19 = m('-3883055495278357133884255336777672572411560830118646314653682162493090494680949274801539986561033/3774045009634729664276442067293310929462816696122544614468334665095836417237230378582105273437500000000000')*(m('9280784638123')*s(11) + m(2))
    c20 = m('25236193726733596737393854392950088667786986729280271069226782191667243067562027856461321896295162131811/275872671830273162630771835836562395791082781009510122381022311711940114970643056390074204808828125000000000000000')*(m('194896477400621')*s('23/2') + m(4))
    c21 = m('-201539919426668053017335610062723121822123353849294299602444827316408533110530087827827897752046913031400914391/12940746478895665105389357764765738641481545149741055523207015122863233421080567004847024102993317419531250000000000000000')*(m('2143861251406871')*s(12) + m(4))
    c22 = m('2889264471964207176908817976433611491392188244874063997073974100578921872573819298482261808158845535960359869600036957/2272130713027470353147989040071527678708496061561741098228359005595002961935649407634367578489055804555904326171875000000000000000')*(m('49308808782358117')*s('25/2') + m(8))
    c23 = m('-6087701393757930630438121662583163938754484330691513123432393618842768864489972489705926413199627387240106928665975838337/7628459158236821035495130118194298208068428714574385285921933845437983305261585901166084878100783044721008227769775390625000000000000')*(m('147926426347074373')*s(13) + m(2))
    c24 = m('499714821155154724192055635481466587305910177223126680494392952981041348051319844000045227087413383516333063208052480567932829696577/8295526857163382584936304267877645974181447795211823937137090698271612731156144960790018233051685943880693964918409216511406250000000000000000000')*(m('3698160658676859371')*s('27/2') + m(4))
    c25 = m('-30023508819070147056421028397853996081209759326484733842284085459179872766314764749647383390174507097964831907699529399401040176584232425159/3425965220139958272877856949243609353797163574636677235577169445046645650935249997372084024271271329149012123350329907433249839355468750000000000000000000')*(m('48076088562799171871')*s(14) + m(4))
    c26 = m('97471086673754123351303360366393885205969956967007807067901921269028883083266758799395886751768733570630030921350239812197561580387661065687651/158468708583698875818502204753167876115932492377912998880911711441711158075700594801049854397643123104734254633446211075985404140178222656250000000000000000000')*(m('1298054391195577640617')*s('29/2') + m(8))
    c27 = m('-6597568037817919166909905608458713969799886602032341262598901949811589786577119561876883656116963358894695241296915364544115030236750944993898430133781/39547487260802617011427204661827127923176792536630306878360074164592051629668380962681407357507933532578557974553238891413631813211470798178100585937500000000000000000')*(m('9086380738369043484371')*s(15) + m(4))
    c28 = m('144578244898200343405729653171148907555881332292329108434502237934874802816999830381166211362755697489005682966070041466655033861384804153899043456104587567203/13214377355931040974872333709252554531838812381948098847646416812252544738231233782890677695857973106556142855147845469535912617826362158691359452880859375000000000000000000000')*(m('263505041412702261046867')*s('31/2') + m(8))
    c29 = m('-41361643146937523165339505029738300623538449472235010288124044622522408489165973547935084445790262235643862309268797849534137010560133850184044650006346053727313128301/29766949463978269387093459230005906222756578592645196959733628244747684548850866774265477421541889757936595766250000013451584483143930400307372679588876333984375000000000000000000000000')*(m('3952575621190533915703117')*s(16) + m(8))
    c30 = m('21686398646550445719100867314692340193996176456320187545075676437386683908382214774538875230473256608873436679296823238958988250858727723100113089038658629933938891023263919/253584469729013452034764343370165855255957535961315100584095566277198747118134134469044358649112465970823085593511892413701113001814624834193863216415479160912738037109375000000000000000000000')*(m('122529844256906551386796859')*s('33/2') + m(16))
    def taylor( xx, only_error = False ):
        x = xx
        v = None
        if not only_error:
            v = c0+x*(c1+x*(c2+x*(c3+x*(c4+x*(c5+x*(c6+x*(c7+x*(c8+x*(c9+x*(c10+x*(c11+x*(c12+x*(c13+x*(c14+x*(c15+x*(c16+x*(c17+x*(c18+x*(c19+x*(c20+x*(c21+x*(c22+x*(c23+x*(c24+x*(c25+x*(c26+x*(c27+x*(c28+x*(c29+x*c30)))))))))))))))))))))))))))))
            v *= m('3/2')
        #We should in principle use the 31st term to estimate the error, but
        #conservatively we use the 30th:
        max_err = m('3/2') * c30 * x**30
        return v, max_err
    return taylor

