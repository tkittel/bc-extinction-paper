from .mpmath import mp, mpf

class Phi0:

    # Evaluate phi^0(s) (s=sigma*r) given by eq. 31.
    #
    # phi^0(s) = (3/64(s^3)) * ( 8*s^2 + 4*s*exp(-4s)-(1-exp(-4s)) )
    #
    # For s ~= 0 we evaluate via a taylor expression for maximum precision.
    #
    # Choosing Taylor expansions to be used for s<0.1 = 1/10, we find the
    # order and coefficients of the Taylor expansion via (aiming for better than
    # 1e-100 precision):
    #
    # sage: p0=(3/(64*x**3))*(8*(x^2)+4*x*exp(-4*x)-(1-exp(-4*x)))
    # sage: float((p0.taylor(x,0,60)-p0)(x=1/10).n(digits=500))
    #       7.870413816767342e-112
    # So we print up to order 60 coefficients via:
    # sage:  print( '\n'.join(('    c%i = mpf("%s")'%(c[1],str(c[0]))) for c in (p0.taylor(x,0,60)).coefficients()))

    def __init__( self ):
        #Taylor coefficients (printed via command above):
        c0 = mpf("1")
        c1 = mpf("-3/2")
        c2 = mpf("8/5")
        c3 = mpf("-4/3")
        c4 = mpf("32/35")
        c5 = mpf("-8/15")
        c6 = mpf("256/945")
        c7 = mpf("-64/525")
        c8 = mpf("512/10395")
        c9 = mpf("-256/14175")
        c10 = mpf("4096/675675")
        c11 = mpf("-2048/1091475")
        c12 = mpf("16384/30405375")
        c13 = mpf("-2048/14189175")
        c14 = mpf("131072/3618239625")
        c15 = mpf("-16384/1915538625")
        c16 = mpf("131072/68746552875")
        c17 = mpf("-65536/162820783125")
        c18 = mpf("1048576/12993098493375")
        c19 = mpf("-524288/34029543673125")
        c20 = mpf("4194304/1494206326738125")
        c21 = mpf("-1048576/2143861251406875")
        c22 = mpf("33554432/410906739852984375")
        c23 = mpf("-8388608/641014514170655625")
        c24 = mpf("67108864/33283445928091734375")
        c25 = mpf("-33554432/112177539979864734375")
        c26 = mpf("536870912/12547859114890583859375")
        c27 = mpf("-268435456/45431903691845217421875")
        c28 = mpf("2147483648/2722885427931256697484375")
        c29 = mpf("-134217728/1317525207063511305234375")
        c30 = mpf("17179869184/1347828286825972065254765625")
        c31 = mpf("-1073741824/694335784122470457858515625")
        c32 = mpf("8589934592/47173990038909022283916796875")
        c33 = mpf("-4294967296/206217727884373725983979140625")
        c34 = mpf("68719476736/29672439734473775016583665234375")
        c35 = mpf("-34359738368/137134789043108527779346128515625")
        c36 = mpf("274877906944/10415026346800295030820866497265625")
        c37 = mpf("-68719476736/25369935972975077639179033775390625")
        c38 = mpf("2199023255552/8113305524157429829009455001369921875")
        c39 = mpf("-549755813888/20777977561866588586487628662044921875")
        c40 = mpf("4398046511104/1744360687693847413237032825294533203125")
        c41 = mpf("-2199023255552/9370867880401831452505920526582259765625")
        c42 = mpf("35184372088832/1648420849870685805508996019903333876953125")
        c43 = mpf("-17592186044416/9267788333717411306528355400789854908203125")
        c44 = mpf("140737488355328/852233579383144561448150942290023614384765625")
        c45 = mpf("-17592186044416/1251151425051850526381327979106630412607421875")
        c46 = mpf("1125899906842624/960467243964803920752066111960856613411630859375")
        c47 = mpf("-140737488355328/1470102924435924368498060375450290734813720703125")
        c48 = mpf("1125899906842624/146951488326614999875066115130011061851979521484375")
        c49 = mpf("-562949953421312/936455562865683822733264459161835198076340087890625")
        c50 = mpf("9007199254740992/194710722032764874834462602547264656953872865966796875")
        c51 = mpf("-4503599627370496/1289499310066046623903705160265847067751120301025390625")
        c52 = mpf("36028797018963968/139218166253426885506640760821294229722019099166259765625")
        c53 = mpf("-9007199254740992/478404244034503297468274614458629262135665631680419921875")
        c54 = mpf("288230376151711744/214256757864023976794720130903971819542187393616873779296875")
        c55 = mpf("-72057594037927936/763054769235032759461898010061513673106386682530269775390625")
        c56 = mpf("576460752303423488/88488040997841902416219414063340361470923393563768870849609375")
        c57 = mpf("-288230376151711744/652411827695953009339922798602594190505960613563380657958984375")
        c58 = mpf("4611686018427387904/156535344525182325374292143478049099442063483214307132532958984375")
        c59 = mpf("-2305843009213693952/1193261232855898054082718798644144774435401962207423223406982421875")
        c60 = mpf("18446744073709551616/147925900576297297478706075586756398972749991637520240243646240234375")
        def taylor( s ):
            return c0+s*(c1+s*(c2+s*(c3+s*(c4+s*(c5+s*(c6+s*(c7+s*(c8+s*(c9+s*(c10+s*(c11+s*(c12+s*(c13+s*(c14+s*(c15+s*(c16+s*(c17+s*(c18+s*(c19+s*(c20+s*(c21+s*(c22+s*(c23+s*(c24+s*(c25+s*(c26+s*(c27+s*(c28+s*(c29+s*(c30+s*(c31+s*(c32+s*(c33+s*(c34+s*(c35+s*(c36+s*(c37+s*(c38+s*(c39+s*(c40+s*(c41+s*(c42+s*(c43+s*(c44+s*(c45+s*(c46+s*(c47+s*(c48+s*(c49+s*(c50+s*(c51+s*(c52+s*(c53+s*(c54+s*(c55+s*(c56+s*(c57+s*(c58+s*(c59+s*c60)))))))))))))))))))))))))))))))))))))))))))))))))))))))))))
        self._eval_taylor = taylor

    def __call__( self, s ):
        if s < 0.1:
            assert s>=0
            return self._eval_taylor(s)
        s2 = s*s
        s3 = s2*s
        fours = mpf(4)*s
        e = mp.expm1(-fours)
        return (mpf('3/64')/s3) * ( mpf(8)*s2 + fours*(mpf(1)+e)+e)

def test_phi0():
    #Reference values via sagemath:
    phi0_refvals = [

        ( mpf('0'), mpf('1') ),
        #two vals on each side of taylor cutoff:
        ( mpf('9999999999999999999999999999999999999999999999999/100000000000000000000000000000000000000000000000000'), mpf('0.864753021088829111353410712826085970864373216959562783650593891158269590180923133948613372426547951259673') ),
        ( mpf('10000000000000000000000000000000000000000000000001/100000000000000000000000000000000000000000000000000'), mpf('0.864753021088829111353410712826085970864373216959538451768887134740340894365505743258189277108556002589214') ),
        #A whole bunch of values:
        ( mpf('1/70000000000'), mpf('0.999999999978571428571755102040812439261418891334959639515281331193671283259790246718676770736503587198695') ),
        ( mpf('1/40000000000'), mpf('0.999999999962500000000999999999979166666667023809523804315476190542328042327298280423287938912938844045615') ),
        ( mpf('1/20000000000'), mpf('0.999999999925000000003999999999833333333339047619047452380952385185185185089947089949013949013913740580408') ),
        ( mpf('1/10000000000'), mpf('0.999999999850000000015999999998666666666758095238089904761905032804232792042328042820586820568760622094562') ),
        ( mpf('1/7000000000'), mpf('0.999999999785714285746938775506316812439642212570127526229152854956729044779529097939117642732738486984182') ),
        ( mpf('1/4000000000'), mpf('0.999999999625000000099999999979166666670238095237574404761970899470892030423281174843674774781545620660204') ),
        ( mpf('1/2000000000'), mpf('0.999999999250000000399999999833333333390476190459523809528042328041375661375853775853740580407252993919660') ),
        ( mpf('1/1000000000'), mpf('0.999999998500000001599999998666666667580952380419047619318518518396613756663011062993003046342441755773213') ),
        ( mpf('1/700000000'), mpf('0.999999997857142860408163261418853259395886631363915831024766925844287440104093618658996999079298230777263') ),
        ( mpf('1/400000000'), mpf('0.999999996250000009999999979166666702380952328869047685185185110780423355579605510712281603427436716034186') ),
        ( mpf('1/200000000'), mpf('0.999999992500000039999999833333333904761903095238099470899461375661394901394866121532847399513974561593741') ),
        ( mpf('1/100000000'), mpf('0.999999985000000159999998666666675809523756190476461375660156613761539201521141574535528668674366198714574') ),
        ( mpf('1/70000000'), mpf('0.999999978571428897959179786200232442831042621132387294430818006478735096673514258339686108944653008116967') ),
        ( mpf('1/40000000'), mpf('0.999999962500000999999979166667023809518601190542328041583994716510341441448212859671188530935586863166013') ),
        ( mpf('1/20000000'), mpf('0.999999925000003999999833333339047618880952385185185089947091871091835818503077169734674496710814169369725') ),
        ( mpf('1/10000000'), mpf('0.999999850000015999998666666758095232761905032804220613757106301088241142180683495253248173052095126508187') ),
        ( mpf('1/7000000'), mpf('0.999999785714318367343051506697606124432282503317383214810594246141111981366229855385759688435071010801268') ),
        ( mpf('1/4000000'), mpf('0.999999625000099999979166670238094717261970899463458995460557891664668279251165225899724905510650933299151') ),
        ( mpf('1/2000000'), mpf('0.999999250000399999833333390476173809528042327089947282347247073919660585411061733093461506162129878021983') ),
        ( mpf('1/1000000'), mpf('0.999998500001599998666667580951847619318518396613805868187808247203658660634437581086896678677540339095519') ),
        ( mpf('1/700000'), mpf('0.999997857146122445092326451277047264356115479802164813047237064337785711886293849648277906160228196239588') ),
        ( mpf('1/400000'), mpf('0.999996250009999979166702380900297685185110780498436679543508189296786799142928428966229495145131230444471') ),
        ( mpf('1/200000'), mpf('0.999992500039999833333904760238099470889947109187073913799780374828125431123844043358254791266950989569389') ),
        ( mpf('1/100000'), mpf('0.999985000159998666675809470476461374442332967754907868861814559877219513235834171445323616332339258936253') ),
        ( mpf('1/70000'), mpf('0.999978571755098153585212193334445945675239547034951592816600071680448384326182109711684948891273827967822') ),
        ( mpf('1/40000'), mpf('0.999962500999979167023804315542327298287938844046193000052779194429198878887458429041976172330552225743760') ),
        ( mpf('1/20000'), mpf('0.999925003999833339047452385185089949013913741172398677292135847713513185453017573493361986458584363193015') ),
        ( mpf('1/10000'), mpf('0.999850015998666758089905032792042820568761228283798575016649791592797874541687592023924269702359391212915') ),
        ( mpf('1/7000'), mpf('0.999785746934888621772676386670437249428637219732832408690187949740742016302274106585385568385094085967095') ),
        ( mpf('1/4000'), mpf('0.999625099979170237574470892031174774787326423333241619121848668176305625421779780142669806565734625930700') ),
        ( mpf('1/2000'), mpf('0.999250399833390459528041375853740586326336934065348974518419522201615646398917195760239504828622804496686') ),
        ( mpf('1/1000'), mpf('0.998501598667580419318396662993009106546620491972264291185942306577812948622198954837378337093412423162241') ),
        ( mpf('1/700'), mpf('0.997860404279800878919997237882147392712017264592447328749019228089006373706899895272958588940023220186396') ),
        ( mpf('1/400'), mpf('0.996259979202328935110855510770049399616199127524658152598238237613321298243905193058261532947308678901200') ),
        ( mpf('1/200'), mpf('0.992539833903099461394866180641359639993179447609729890503629710566894413422997281050785313490748227018129') ),
        ( mpf('1/100'), mpf('0.985158675756460161521202008236943863639568748432866642682148288305028014961556509923784615111734738367569') ),
        ( mpf('1/70'), mpf('0.978894109678811560720116580091445901147888964684767042354667649592976892113644113718926322210664745767686') ),
        ( mpf('1/40'), mpf('0.963479518666591442021896173240849942527691235323141785649146284073885636019591341261371919098508886979860') ),
        ( mpf('1/20'), mpf('0.928838885091836401470978878567740961366065321057052615112942727428949831120994380555741837944639805822064') ),
        ( mpf('1/10'), mpf('0.864753021088829111353410712826085970864373216959550617709740512949305242273214438603401324767551976799453') ),
        ( mpf('1/7'), mpf('0.814831301352291277816990649986712073709018987276341455394647234554497451441202586024690273296790792708305') ),
        ( mpf('1/4'), mpf('0.707276647028653929573142620968765204674866786190607007047020810184768974469398820142883646075517862479764') ),
        ( mpf('1/2'), mpf('0.527252193641189278380749431844044953833585489148272866651678731735832545864173651179235387801989179849462') ),
        ( mpf('1'), mpf('0.332417727864547073506340161235915916143416890832845842524124982993574319905807997504852226123961418374115') ),
        ( mpf('10/7'), mpf('0.246777959004184112256851270213760687312610554429847965123528661492653833825658998091782317863782824855467') ),
        ( mpf('5/2'), mpf('0.147001498197682162000100674520013498170137851296932596643985549353086482980913271975294533325150016276817') ),
        ( mpf('5'), mpf('0.0746250000162315847767036428952317804937270901889594822953429415821564267103296666873034049070792985572565') ),
        ( mpf('10'), mpf('0.0374531250000000000081648058343885226003983730983064833781122900494136389598476676098109697947345391008569') ),
        ( mpf('100/7'), mpf('0.0262339218750000000000000001425293264040525021003007865812924274171343434867046451523639127745445250945256') ),
        ( mpf('25'), mpf('0.0149970000000000000000000000000000000000000000112718302073431329677678782857052485621974436459016493603755') ),
        ( mpf('50'), mpf('0.00749962500000000000000000000000000000000000000000000000000000000000000000000000000000000010431120070278159') ),
        ( mpf('100'), mpf('0.00374995312500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('1000/7'), mpf('0.00262498392187500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('250'), mpf('0.00149999700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('500'), mpf('0.000749999625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('1000'), mpf('0.000374999953125000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('10000/7'), mpf('0.000262499983921875000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('2500'), mpf('0.000149999997000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('5000'), mpf('0.0000749999996250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('10000'), mpf('0.0000374999999531250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('100000/7'), mpf('0.0000262499999839218750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('25000'), mpf('0.0000149999999970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') ),
        ( mpf('50000'), mpf('7.49999999962500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-6') ),
        ( mpf('100000'), mpf('3.74999999995312500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-6') ),
        ( mpf('1000000/7'), mpf('2.62499999998392187500000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-6') ),
        ( mpf('250000'), mpf('1.49999999999700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-6') ),
        ( mpf('500000'), mpf('7.49999999999625000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-7') ),
        ( mpf('1000000'), mpf('3.74999999999953125000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-7') ),
        ( mpf('10000000/7'), mpf('2.62499999999983921875000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-7') ),
        ( mpf('2500000'), mpf('1.49999999999997000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-7') ),
        ( mpf('5000000'), mpf('7.49999999999996250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-8') ),
        ( mpf('10000000'), mpf('3.74999999999999531250000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-8') ),
        ( mpf('100000000/7'), mpf('2.62499999999999839218750000000000000000000000000000000000000000000000000000000000000000000000000000000000e-8') ),
        ( mpf('25000000'), mpf('1.49999999999999970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-8') ),
        ( mpf('50000000'), mpf('7.49999999999999962500000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-9') ),
        ( mpf('100000000'), mpf('3.74999999999999995312500000000000000000000000000000000000000000000000000000000000000000000000000000000000e-9') ),
        ( mpf('1000000000/7'), mpf('2.62499999999999998392187500000000000000000000000000000000000000000000000000000000000000000000000000000000e-9') ),
        ( mpf('250000000'), mpf('1.49999999999999999700000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-9') ),
        ( mpf('500000000'), mpf('7.49999999999999999625000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-10') ),
        ( mpf('1000000000'), mpf('3.74999999999999999953125000000000000000000000000000000000000000000000000000000000000000000000000000000000e-10') ),
    ]
    p0 = Phi0()
    maxerr = mpf('1e-102')
    for s, ref in phi0_refvals:
        v = p0(s)
        #print(type(v))
        d = abs(v-ref)/ref
        #print( s, ref, v, d )
        print(s, d)
        assert 0.0 <= d < maxerr
