from .mpmath import mp, mpf

class PhiPi:

    # Evaluate phi^0(s) (s=sigma*r) given by eq. 31.
    #
    # phi^pi(s) = ( 3/(4*s**3) )*( s**2 - s + log(1+2*s) / 2 )
    #
    # ERRATA DISCOVERED THROUGH PAINFUL PROCESS: Factor of 1/2 in eq. 31 in
    # paper is placed in the wrong location. It has to be moved from second term
    # in the nominator to the third (logarithmic) term.
    # For s ~= 0 we evaluate via a taylor expression for maximum precision.
    #
    # Choosing Taylor expansions to be used for s<0.01 = 1/100, we find the
    # order and coefficients of the Taylor expansion via (aiming for better than
    # 1e-100 precision):
    #
    # sage: ppi=(3/(4*x**3))*(x^2-x+log(1+2*x)/2)
    # sage: float((ppi.taylor(x,0,60)-ppi)(x=1/100).n(digits=500))
    #       1.0599903499351085e-105
    # So we print up to order 60 coefficients via:
    # sage: print( '\n'.join(('    c%i = mpf("%s")'%(c[1],str(c[0]))) for c in (ppi.taylor(x,0,60)).coefficients()))

    def __init__( self ):
        #Taylor coefficients (printed via command above):
        c0 = mpf("1")
        c1 = mpf("-3/2")
        c2 = mpf("12/5")
        c3 = mpf("-4")
        c4 = mpf("48/7")
        c5 = mpf("-12")
        c6 = mpf("64/3")
        c7 = mpf("-192/5")
        c8 = mpf("768/11")
        c9 = mpf("-128")
        c10 = mpf("3072/13")
        c11 = mpf("-3072/7")
        c12 = mpf("4096/5")
        c13 = mpf("-1536")
        c14 = mpf("49152/17")
        c15 = mpf("-16384/3")
        c16 = mpf("196608/19")
        c17 = mpf("-98304/5")
        c18 = mpf("262144/7")
        c19 = mpf("-786432/11")
        c20 = mpf("3145728/23")
        c21 = mpf("-262144")
        c22 = mpf("12582912/25")
        c23 = mpf("-12582912/13")
        c24 = mpf("16777216/9")
        c25 = mpf("-25165824/7")
        c26 = mpf("201326592/29")
        c27 = mpf("-67108864/5")
        c28 = mpf("805306368/31")
        c29 = mpf("-50331648")
        c30 = mpf("1073741824/11")
        c31 = mpf("-3221225472/17")
        c32 = mpf("12884901888/35")
        c33 = mpf("-2147483648/3")
        c34 = mpf("51539607552/37")
        c35 = mpf("-51539607552/19")
        c36 = mpf("68719476736/13")
        c37 = mpf("-51539607552/5")
        c38 = mpf("824633720832/41")
        c39 = mpf("-274877906944/7")
        c40 = mpf("3298534883328/43")
        c41 = mpf("-1649267441664/11")
        c42 = mpf("4398046511104/15")
        c43 = mpf("-13194139533312/23")
        c44 = mpf("52776558133248/47")
        c45 = mpf("-2199023255552")
        c46 = mpf("211106232532992/49")
        c47 = mpf("-211106232532992/25")
        c48 = mpf("281474976710656/17")
        c49 = mpf("-422212465065984/13")
        c50 = mpf("3377699720527872/53")
        c51 = mpf("-1125899906842624/9")
        c52 = mpf("13510798882111488/55")
        c53 = mpf("-3377699720527872/7")
        c54 = mpf("18014398509481984/19")
        c55 = mpf("-54043195528445952/29")
        c56 = mpf("216172782113783808/59")
        c57 = mpf("-36028797018963968/5")
        c58 = mpf("864691128455135232/61")
        c59 = mpf("-864691128455135232/31")
        c60 = mpf("1152921504606846976/21")
        def taylor( s ):
            return c0+s*(c1+s*(c2+s*(c3+s*(c4+s*(c5+s*(c6+s*(c7+s*(c8+s*(c9+s*(c10+s*(c11+s*(c12+s*(c13+s*(c14+s*(c15+s*(c16+s*(c17+s*(c18+s*(c19+s*(c20+s*(c21+s*(c22+s*(c23+s*(c24+s*(c25+s*(c26+s*(c27+s*(c28+s*(c29+s*(c30+s*(c31+s*(c32+s*(c33+s*(c34+s*(c35+s*(c36+s*(c37+s*(c38+s*(c39+s*(c40+s*(c41+s*(c42+s*(c43+s*(c44+s*(c45+s*(c46+s*(c47+s*(c48+s*(c49+s*(c50+s*(c51+s*(c52+s*(c53+s*(c54+s*(c55+s*(c56+s*(c57+s*(c58+s*(c59+s*c60)))))))))))))))))))))))))))))))))))))))))))))))))))))))))))
        self._eval_taylor = taylor

    def __call__( self, s ):
        if s < 0.01:
            assert s>=0
            return self._eval_taylor(s)
        s2 = s*s
        s3 = s2*s
        return (mpf('3/4')/s3) * ( s2 -s + mpf('1/2')*mp.log1p( mpf(2)*s ) )

def test_phipi():
    #Reference values via sagemath:
    phipi_refvals = [
        ( mpf('0'), mpf('1') ),
        #two vals on each side of taylor cutoff:
        ( mpf('999999999999999999999999999999999999999999999999/100000000000000000000000000000000000000000000000000'), mpf('0.985236067392384760900081912647415871522816701327921765336243182215445547430213560530179415644317424829262') ),
        ( mpf('1000000000000000000000000000000000000000000000001/100000000000000000000000000000000000000000000000000'), mpf('0.985236067392384760900081912647415871522816701327892701873065344238280350071976124124571927201055863780575') ),
        #A whole bunch of values:
        ( mpf('1/70000000000'), mpf('0.999999999978571428571918367346927113702624192300827029214017968884846733357570076284338612061630031253614') ),
        ( mpf('1/40000000000'), mpf('0.999999999962500000001499999999937500000002678571428454241071433779761904527529761915415313852325571563875') ),
        ( mpf('1/20000000000'), mpf('0.999999999925000000005999999999500000000042857142853392857143190476190446190476193203463203213203463226540') ),
        ( mpf('1/10000000000'), mpf('0.999999999850000000023999999996000000000685714285594285714307047619043779047619745800865672865800889431635') ),
        ( mpf('1/7000000000'), mpf('0.999999999785714285763265306110787172014517760456238472065392254361089746781094985154757853642690226399038') ),
        ( mpf('1/4000000000'), mpf('0.999999999625000000149999999937500000026785714273995535719494047616703869048684388527650246888753499104957') ),
        ( mpf('1/2000000000'), mpf('0.999999999250000000599999999500000000428571428196428571761904761604761905034632034382034632265401265186980') ),
        ( mpf('1/1000000000'), mpf('0.999999998500000002399999996000000006857142845142857164190476152076190546008657880658008894316349877493174') ),
        ( mpf('1/700000000'), mpf('0.999999997857142862040816314868804693282560766347355449968408388309213156733683758693650314542570949143870') ),
        ( mpf('1/400000000'), mpf('0.999999996250000014999999937500000267857141685267862351190452752976297010280897000137534991040152881022022') ),
        ( mpf('1/200000000'), mpf('0.999999992500000059999999500000004285714248214286047619044619047646320346070346322654012632584082784082582') ),
        ( mpf('1/100000000'), mpf('0.999999985000000239999996000000068571427371428592761904377904768886579958580088943163459277789696988862429') ),
        ( mpf('1/70000000'), mpf('0.999999978571429061224478134111072767292199678886631699247438728850333815414914009661944769944787750274595') ),
        ( mpf('1/40000000'), mpf('0.999999962500001499999937500002678571311383933779761670386915415313364532625349909459843590702914585973623') ),
        ( mpf('1/20000000'), mpf('0.999999925000005999999500000042857139107143190476160476193203462953463226540124397269597269378519399034103') ),
        ( mpf('1/10000000'), mpf('0.999999850000023999996000000685714165714307047615207619745800737800889431630643064422263449463631976538779') ),
        ( mpf('1/7000000'), mpf('0.999999785714334693865889215683940500981915131687031937989099166789224537941864329144381752814511389092514') ),
        ( mpf('1/4000000'), mpf('0.999999625000149999937500026785702566969494045275298684388039857503499000429957461135744860810188473243610') ),
        ( mpf('1/2000000'), mpf('0.999999250000599999500000428571053571761904461905034631784632265401051115751115363615727585972684336461118') ),
        ( mpf('1/1000000'), mpf('0.999998500002399996000006857130857164190437790546008530008894315911460026657671462098747863783280719216459') ),
        ( mpf('1/700000'), mpf('0.999997857147755090379037305813054265937479080425349154200718354187372751160482103366569079939845632055194') ),
        ( mpf('1/400000'), mpf('0.999996250014999937500267855970987351167038797009793106284980587495235655027000056165315889608350139491471') ),
        ( mpf('1/200000'), mpf('0.999992500059999500004285676786047616047646320096322653991225641223566243088117599667118692044349538312721') ),
        ( mpf('1/100000'), mpf('0.999985000239996000068570228592761520768886452088943119618268402089506573167984065926931347593782268100998') ),
        ( mpf('1/70000'), mpf('0.999978571918355685416783483253854981990097640193150397226965122650306873379469396631334762046238387139116') ),
        ( mpf('1/40000'), mpf('0.999962501499937502678454246279527540414825594098864238022056735565084463048074274225316428905888997964326') ),
        ( mpf('1/20000'), mpf('0.999925005999500042853393190446193203213226537983882964934748222215157232019841638665829239939882659341406') ),
        ( mpf('1/10000'), mpf('0.999850023996000685594307043779745672889427247279252889113941084179838172583139922172377627253057411370584') ),
        ( mpf('1/7000'), mpf('0.999785763253647170107874506787508056957830162203960490123619994038273676969946976942062798057796038772058') ),
        ( mpf('1/4000'), mpf('0.999625149937526774000741704933900472144522170424072408811764864148178609236696468464873837286287861160610') ),
        ( mpf('1/2000'), mpf('0.999250599500428196761605034382265187179499655991059000486700974872976158662888764286602736453396780179679') ),
        ( mpf('1/1000'), mpf('0.998502396006845164152145880893878310840379016605653270133447880238416446242253111005191802208693263535114') ),
        ( mpf('1/700'), mpf('0.997862029183007261248444987762685831884504173648634710462914744170201142102533085518532046531139937557923') ),
        ( mpf('1/400'), mpf('0.996264937766690452859024243326481288386244245984443423671621374978135108498432132931019414938303884109411') ),
        ( mpf('1/200'), mpf('0.992559504248544646072632782225066038829820176393593828679300599992742916733098057089688280483493576815522') ),
        ( mpf('1/100'), mpf('0.985236067392384760900081912647415871522816701327907233604654263226862948751094842327375671422686644076518') ),
        ( mpf('1/70'), mpf('0.979049841314406811134581838281799438858028822973234691656693833434041808732773107449345061084612256944826') ),
        ( mpf('1/40'), mpf('0.963940066368073568985701355951806591367945973977840961837754738590183767144931665929311574079117529498997') ),
        ( mpf('1/20'), mpf('0.930539412974580131856369842295276661816095925932597555719424489003042707652698517172508739109479218243826') ),
        ( mpf('1/10'), mpf('0.870583797732984829394259432942987449021001717932618978522419371265847805242219193504451393864187073751953') ),
        ( mpf('1/7'), mpf('0.825318337631544242250840572940744795996922657435401093161059292524197084002247159050078544967604681222730') ),
        ( mpf('1/4'), mpf('0.731162594595945167472314771144379277727770163099860742736343779458416109973942030426058267615521629903245') ),
        ( mpf('1/2'), mpf('0.579441541679835928251696364374529704226500403080765762362040028480180865909084146817589980989256062626004') ),
        ( mpf('1'), mpf('0.411979608250541134273216963845947139242808959183531044400510375114060359956978362577605908055149533295489') ),
        ( mpf('10/7'), mpf('0.331134323967567153297964259172100613556280395657386549322536117956646900549245825523168905007883894601575') ),
        ( mpf('5/2'), mpf('0.223002227261473320019499456601136854545351776612392112940528984235141309964519288379507497963443618631919') ),
        ( mpf('5'), mpf('0.127193685818395111632185830733895387899465120561812251525655703127391720871739710139225164124007904374244') ),
        ( mpf('10'), mpf('0.0686416959141462836236877242426371395378567157327767289900727816813406528084890043379979778450256013559179') ),
        ( mpf('100/7'), mpf('0.0492606282618615184232222694235645272205306480906537864484077355347212742033487969282648194190231465626775') ),
        ( mpf('25'), mpf('0.0288943638151853838185194747165150956537656566456898038617367663697164748848564689659468570549484296408714') ),
        ( mpf('50'), mpf('0.0147138453615505237783526525948007389674706726477615928142497937960851060356508070316145140403202258702735') ),
        ( mpf('100'), mpf('0.00742698873934052215340664949396248234317070540879789174179582717942415478604953001094881719872848803409000') ),
        ( mpf('1000/7'), mpf('0.00521397782278744168931957181987317357963073010798446126608121573270443170947576920606617595578758691349456') ),
        ( mpf('250'), mpf('0.00298814919854642603675516771990432801532169067551585040978523826509793036444530475535796195527802286930432') ),
        ( mpf('500'), mpf('0.00149702072626433794566175566235128892088290279217858483845644029101010919485446196914848078686361009298742') ),
        ( mpf('1000'), mpf('0.000749252850525875468900028519476287910487535719143919969723477245625023536225620127972349387018985669218747') ),
        ( mpf('10000/7'), mpf('0.000524633523588404396276329197218653369174749086799365536719782185756040838003020652099039473416644674132689') ),
        ( mpf('2500'), mpf('0.000299880204417436114053688641249352778580761946695643406781002944129030449948815831140674571160332795706420') ),
        ( mpf('5000'), mpf('0.000149970027631321100929548133221896956255223884403664056748488938937918694575806064350444920063986302713845') ),
        ( mpf('10000'), mpf('0.0000749925037138265817323136414725351640968418752775629009460741659951546497651006173911574431509296814185892') ),
        ( mpf('100000/7'), mpf('0.0000524963263197179029052979478060581177206384372200373467954633112583627269115247679419286158445136731339724') ),
        ( mpf('25000'), mpf('0.0000299988002596751588210468586551854190068714716668148053475439602338359615806269218031873581821996275138180') ),
        ( mpf('50000'), mpf('0.0000149997000345388063947606862602623718802649631183021991154792106881462386108362431363859284271062011644616') ),
        ( mpf('100000'), mpf('7.49992500457727911706912766419013742956437312572206309111072241234272602115223853708649309840775061696353e-6') ),
        ( mpf('1000000/7'), mpf('5.24996325161588385888215022190876118971608263349634014244732607970376628314347186162501536970245593816135e-6') ),
        ( mpf('250000'), mpf('2.99998800031493676905765589113657710255970580800474704999427204095809091610643355478683532019777631939108e-6') ),
        ( mpf('500000'), mpf('1.49999700004144653467389132231332384543431915573631982722388896714036180667932134160597697690964900080736e-6') ),
        ( mpf('1000000'), mpf('7.49999250005440746839446535405087567812727263023879814337718361518979141125194487521956241721656684630957e-7') ),
        ( mpf('10000000/7'), mpf('5.24999632501912053461300539296022902806151068800312966963956238809671879991936268121557372347620331469786e-7') ),
        ( mpf('2500000'), mpf('2.99999880000370198768089560507489072993462376950779172790865031619581308482785758124786186274752326067531e-7') ),
        ( mpf('5000000'), mpf('1.49999970000048354287252874944364378820548296648365623130761204275353838993063509500963700595288418894770e-7') ),
        ( mpf('10000000'), mpf('7.49999925000063042160805693489428287052390926863205046414570590623242354174839738660174177855745250556823e-8') ),
        ( mpf('100000000/7'), mpf('5.24999963250022082234283700312216263180301329664834943694884335955108802748621531908716515851874544604255e-8') ),
        ( mpf('25000000'), mpf('2.99999988000004254608060014180791054408523844007302256148425918222853038912081097039240675408832166759523e-8') ),
        ( mpf('50000000'), mpf('1.49999997000000552620422618570962664317959124247334824264957270900514248041553374699569183040785702829806e-8') ),
        ( mpf('100000000'), mpf('7.49999992500000716768547356711653839793642522490877723786725064641367183274289173057926958104219641101463e-9') ),
        ( mpf('1000000000/7'), mpf('5.24999996325000250439343190470292572811471956443170434291904009975655741844540182891043281027321563986408e-9') ),
        ( mpf('250000000'), mpf('2.99999998800000048072284780127518027387258336082643111202591847276883646830250682001137885217832106462515e-9') ),
        ( mpf('500000000'), mpf('1.49999999700000006216979751383923346698576927747783360447974019357687035239985332655303188948494553813383e-9') ),
        ( mpf('1000000000'), mpf('7.49999999250000008031154881752383674545308205122170413676170699509548264406760106825998692685231319394306e-10') ),
    ]
    p0 = PhiPi()
    maxerr = mpf('1e-102')
    for s, ref in phipi_refvals:
        v = p0(s)
        #print(type(v))
        d = abs(v-ref)/ref
        #print( s, ref, v, d )
        #print(s, d)
        assert 0.0 <= d < maxerr
