from .mpmath import mp, mpf
from mpmath import extraprec

class F_of_Eta:

    # Evaluate f(eta) for secondary extinction (BC, Fresnel) given by BC1974
    # eq. 44 (eta=(3/4)*pi*eps_1*alphaG), normalised so f(eta=0) = 1:
    #
    # f = [ sin( (4eta/3) ) / ( 4eta/3) ]^2 = sinc^2(4eta/4)
    #
    # Since mpmath provides the sinc(x) function, this can simply be evaluated
    # via that function. However, it turns out that mpmath.extraprec is needed
    # for this.

    def __call__( self, eta ):
        with extraprec(500):
            return mp.sinc(mpf('3/4') * abs(mpf(eta))) ** 2

def test_f_of_eta_fresnel():

    #Reference values mostly generated via the following function after setting mp.dps=100000:
    #fref = lambda eta : mp.nstr(mpf( mp.sinc(mpf(eta)*mpf('3/4'))**2 ),n=120)

    period = mp.pi*mpf('4/3') # zeroes at integer times period
    f_of_eta_refvals = [

        ( mpf(0), mpf(1) ),

        #sin(pi/6) is 0.5, so
        # f((4/3)*pi/6)=f(2pi/9) = ( 1/2 / ( (3/4)*2pi/9) )^2
        #                         = ( 4*9 / ( 2*3*2*pi ) )^2
        #                         = 9/pi^2
        ( mpf('2/9')*mp.pi, mpf(9)*mp.pi**(-2) ),

        ( period*1, mpf(0) ),
        ( period*10, mpf(0) ),
        ( period*100, mpf(0) ),
        ( period*1000, mpf(0) ),
        ( period*10000, mpf(0) ),
        ( period*(-10), mpf(0) ),

        ( 2, '0.442220554800098990504793954384724733865262021470130739736463540650739821669585160095176550967931689371443554024980926487' ),

        #two vals on each side of taylor cutoff:
        ( mpf('1/10')-mpf('1e-10'),
          '0.998126405688874446388759620232356878855313167372762934408611582760501902009403047693102886009511825137318810749769816874' ),

        ( mpf('1/10')+mpf('1e-10'),
          '0.998126405681385689610885254831623770594981460839307620016873619964369618176875498827665425404373186935674333843193329182' ),

        ( mpf(117),
          '0.00000588932239439324142265418823231166063648739916896780834230599112119808127442823347873219674519340652848730287475163977491' ),

        ( mpf('1/100'),
          '0.999981250140624434990251811208356390735638863329007249514769798379866266908449107617740063563904084049752134720861268428' ),


        #4pi/3 - 1e-5:
        ('4.1888002047863909846168578443726705122628925325001410946332594564104218750482786648373797671228227573095307820177097421961251261460674429756338125441713081566003788036025846948074128594972652732405093',
         '0.00000000000569928936763990627425658004974053223759665302078258460273313215261444030119830294306553138210083002230566710269421158095'),


        #4pi/3 - 1e-10:
        (
            '4.1887902048863909846168578443726705122628925325001410946332594564104218750482786648373797671228227573095307820177097421961251261460674429756338125441713081566003788036025846948074128594972652732405093',
            '0.00000000000000000000056993165796093773219371575598098545003725631771267696816948412183798898726963846728747841842574446488688742052152064316'
        ),

        #4pi/3 - 1e-100:
        ('4.1887902047863909846168578443726705122628925325001410946332594564104218750482786648373797671228227574095307820177097421961251261460674429756338125441713081566003788036025846948074128594972652732405093',
         '5.69931657988149964371821980554717968837018107531386837256550804404723805412574356700552165831622836710075700398395215124e-202' ),

        ('123456' , '0.00000000000297088312455901030612224594958375884985652285770354187535459684711789078660821890060476006414115008813294769162809721887'),
        ('-123456' , '0.00000000000297088312455901030612224594958375884985652285770354187535459684711789078660821890060476006414115008813294769162809721887'),

        ('12' , '0.00209681044293777688385123429141697046489050269998630806918031045009297730855302478516415597792561155204320078598873985146'),

        ('0.00001' , '0.99999999998125000000014062499999943498883928712681361606902085341416693761342939705069163428678220321889825688148050661'),
        ('0.0789' , '0.998833317956145021998343971177992105005975899714311274301014333659586018406297331884432205882437334928445543947771758309'),
        ('-0.00001' , '0.99999999998125000000014062499999943498883928712681361606902085341416693761342939705069163428678220321889825688148050661'),


    ]
    f = F_of_Eta()
    maxerr = mpf('1e-102')
    i=0
    for eta, ref in f_of_eta_refvals:
        i+=1
        print()
        print('----> test point %i'%i)
        ref = mpf(ref)
        v = f(eta)
        assert v>=0
        print('eta=',eta)
        print('ref=',ref)
        print('val=',v)
        d = mpf(0) if v==ref else (abs(v-ref)/(mpf('0.5')*(abs(ref)+abs(v))))
        if ref==0 and v!=ref and v<1e-150:
            print("WARNING: ref is 0 and res is extremely close to zero,"
                  " marking as OK despite reldiff out of bounds!")
            d = mpf(0)
        print(float(eta), float(d))
        assert 0.0 <= d < maxerr
    print("Fresnel f(eta) tests done")
