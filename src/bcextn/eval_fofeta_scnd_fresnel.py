from .mpmath import mp, mpf

class F_of_Eta:

    # Evaluate f(eta) for secondary extinction (BC, Fresnel) given by BC1974
    # eq. 44 (eta=(3/4)*pi*eps_1*alphaG), normalised so f(eta=0) = 1:
    #
    # f = [ sin( (4eta/3) ) / ( 4eta/3) ]^2
    #
    # For small arguments, the function is evaluated via a Taylor expansion
    # to ensure numerical precision and stability.

    def __init__( self ):
        # Taylor expansion to be used for eta<0.1. Code validated and
        # produced by the script bin/sagemath_taylor_f_of_eta_fresnel:
        c0 = mpf("1")
        c2 = mpf("-3/16")
        c4 = mpf("9/640")
        c6 = mpf("-81/143360")
        c8 = mpf("81/5734400")
        c10 = mpf("-243/1009254400")
        c12 = mpf("2187/734737203200")
        c14 = mpf("-6561/235115905024000")
        c16 = mpf("6561/31975763083264000")
        c18 = mpf("-59049/48603159886561280000")
        c20 = mpf("177147/29939546490121748480000")
        c22 = mpf("-531441/22035506216729606881280000")
        c24 = mpf("4782969/57292316163496977891328000000")
        c26 = mpf("-1594323/6416739410311661523828736000000")
        c28 = mpf("4782969/7443417715961527367641333760000000")
        c30 = mpf("-43046721/29535481496935340594800812359680000000")
        c32 = mpf("129140163/44185080319415269529822015290081280000000")
        c34 = mpf("-129140163/24743644978872550936700328562445516800000000")
        c36 = mpf("1162261467/139158259361179226468002647835193586483200000000")
        c38 = mpf("-3486784401/289449179471252791053445507497202659885056000000000")
        c40 = mpf("10460353203/664575316065996408258710885213577307096088576000000000")
        c42 = mpf("-94143178827/5029505991987460817701923979296353060103198343168000000000")
        c44 = mpf("94143178827/4627145512628463952285770060952644815294942475714560000000000")
        c46 = mpf("-282429536481/13918453701986419568475596343345555604407186966949396480000000000")
        c48 = mpf("2541865828329/136400846279466911771060844164786444923190432276104085504000000000000")
        c50 = mpf("-7625597484987/482313392444195000022471144966684869248401368528304046342144000000000000")
        c52 = mpf("2541865828329/204500878396338680009527765465874384561322180256000915649069056000000000000")
        c54 = mpf("-22876792454961/2519450821842892537717382070539572417795489260753931280796530769920000000000000")
        c56 = mpf("68630377364883/11105739222683470306258220166938435217642516661403329085751107633807360000000000000")
        c58 = mpf("-205891132094649/52419089131065979845538799187949414227272678641823713284745228031570739200000000000000")
        c60 = mpf("1853020188851841/792995980374766143103310954115298738430181082493509134571625809661602142617600000000000000")
        def taylor( eta ):
            x = eta*eta
            return c0+x*(c2+x*(c4+x*(c6+x*(c8+x*(c10+x*(c12+x*(c14+x*(c16+x*(c18+x*(c20+x*(c22+x*(c24+x*(c26+x*(c28+x*(c30+x*(c32+x*(c34+x*(c36+x*(c38+x*(c40+x*(c42+x*(c44+x*(c46+x*(c48+x*(c50+x*(c52+x*(c54+x*(c56+x*(c58+x*c60)))))))))))))))))))))))))))))

        self._eval_taylor = taylor
        self._k = mpf('3/4')

    def __call__( self, eta ):
        if eta < 0:
            eta = -eta
        eta=mpf(eta)
        if eta < 0.1:
            return self._eval_taylor(eta)
        return mp.sinc(self._k * eta) ** 2

def test_f_of_eta_fresnel():
    #Reference values via sagemath, mpmath (high dps) and manual calcs:
    period = mp.pi*mpf('4/3')
    f_of_eta_refvals = [

        ( mpf(0), mpf(1) ),
        ( period*1, mpf(0) ),
        ( period*10, mpf(0) ),
        ( period*100, mpf(0) ),
        ( period*1000, mpf(0) ),
        ( period*10000, mpf(0) ),
        ( period*(-10), mpf(0) ),

        #two vals on each side of taylor cutoff:
        ( mpf('1/10')-mpf('1e-10'),
          mpf('0.99812640568887444618090486542424239187260687190714645934546809171085716163050465453042389805107052739152459462223936444041215463115029240543425854421914118557659826899146150733749677382563205483498725103307031535190702579182197928283556236105400396868035735349602433652723748382500848191043703323280956007545928021952838010054622717775224843075797200298276856755849713240628473610253096730000484251759100757663810530024918475243992325180189630544602177255864905588856418660712889843133410835346582903842') ),

        ( mpf('1/10')+mpf('1e-10'),
          mpf('0.99812640568138568940303049960904726974466025289835806961512419075179206138529814711094395912553475131602349294454472057179432360567084496545303877658241229950440158657659465648987415191272923140714280204180682301889426444255050205940434317709080321157196500999858881208389715940268040186146365150900952220772938711936078106189148728384047823325537875341958386380486661796688444125260562874142711803529309769649877185700075700407700755423669927133223936538733143297194659215589869680316472446805703844561') ),

        ( mpf(117),
          mpf('0.0000058893223943932414226541882323116606364873991689678083423059911211980812744282334787321967451934065284873028747516397749098054649940094376497343789366742141987673733172451856449691474080328562854512077708178427095849139265634317632097643770295610319035522324571125594458611884618437196735446538628589979519490833231553706034155128890797074100879002651172136597117037821279490875758755792672367414588537928004713044401561278974584228589030768154365009102108931966019788191571253462418677172168672539925773') ),

        ( mpf('1/100'),
          mpf('0.99998125014062443499025181120835639073563886332900724951476979837986626690844910761774006356390408404975213472086126842781417602852113356088847333536800574861596112084047096271738045821115751698358588441120610032141724737323190100301277208873133760452459288621647825322431323224609146899575656167828097851348306014321101171981049096822844466815295943330600587746866737345619748670532775675483349252979850280890283029484869599697672571950247002908880421306778586139079313150789777923083972714664044281079') ),


        ( ( mp.pi*mpf('4/3') + mpf('1/1000000')),
          mpf('0.000000000000056993138586581876871369705446622399867985411697548048896661952540542982427662486327159283025237443741382363768754486208569568457516079889591154514062659940334573118633359047083890332083216982278639924110373921975163412864164247303488254455269448613373648470670303698385512998539299401930672000340431598660314065117287379886365722561980298391236306827245195465386573996245066857611514034801850180661921402818388365440423266992221990617515588604916583088482343342320361863027548358953910971165772553163594') ),

        ( ( mp.pi*mpf('4/3') + mpf('1/1000000')),
          mpf('0.000000000000056993193011046232891506762133191079936284441041825764370617571326555573028529522475373012171539230748498224163687259959169651760550989128282021987391786650687956194871223428117602114530619117606415859129764637902341168021474358967629183068813117814434542230766635290136581641158253935990136683969293121186804309103164368058786878705842979953347803056129168335139608981584202764850516093108485847222571231280077334887628446711965820067048965538285183377589221651830733098609585632437913423689685113573289') )

        ( -( mp.pi*mpf('4/3') + mpf('1/1000000')),
          mpf('0.000000000000056993193011046232891506762133191079936284441041825764370617571326555573028529522475373012171539230748498224163687259959169651760550989128282021987391786650687956194871223428117602114530619117606415859129764637902341168021474358967629183068813117814434542230766635290136581641158253935990136683969293121186804309103164368058786878705842979953347803056129168335139608981584202764850516093108485847222571231280077334887628446711965820067048965538285183377589221651830733098609585632437913423689685113573289') )

    ]
    f = F_of_Eta()
    maxerr = mpf('1e-102')
    for eta, ref in f_of_eta_refvals:
        v = f(eta)
        #print(type(v))
        d = abs(v-ref)/ref
        #print( eta, ref, v, d )
        print(eta, d)
        assert 0.0 <= d < maxerr
